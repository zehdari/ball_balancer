<?xml version="1.0" encoding="utf-8"?>
<!-- Merged URDF for Isaac Sim: tree + closed-loop constraints via <loop_joint>.
     Robot base is fixed to world, table is a floating body, legs close to table magnets with spherical loop joints. -->
<robot name="ball_balancer_system">

  <!-- World link -->
  <link name="world"/>

  <!-- =======================
       ROBOT (formerly ball_balancer2)
       ======================= -->

  <link name="robot_base_link">
    <inertial>
      <origin xyz="-0.00015538 0.039405 0.00054565" rpy="0 0 0" />
      <mass value="0.25395" />
      <inertia
        ixx="0.00052253" ixy="-1.5515E-06" ixz="-2.7765E-06"
        iyy="0.00059627" iyz="4.2751E-06"
        izz="0.00051908" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/base_link.STL" />
      </geometry>
      <material name="">
        <color rgba="0.79216 0.81961 0.93333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/base_link.STL" />
      </geometry>
    </collision>
  </link>

  <!-- Fix robot base to world -->
  <joint name="world_to_robot_base" type="fixed">
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <parent link="world"/>
    <child link="robot_base_link"/>
  </joint>

  <!-- Servo arm 1 -->
  <link name="servo_arm_1">
    <inertial>
      <origin xyz="3.6744E-05 0.014137 -6.245E-17" rpy="0 0 0" />
      <mass value="0.0030998" />
      <inertia
        ixx="7.5306E-07" ixy="1.4846E-22" ixz="2.8325E-25"
        iyy="5.9756E-08" iyz="-1.1677E-21"
        izz="7.0606E-07" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/servo_arm.STL" />
      </geometry>
      <material name="">
        <color rgba="0.79216 0.81961 0.93333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/servo_arm.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="servo_arm_1_revolute" type="revolute">
    <origin xyz="-0.0073 -0.065736 0.03755" rpy="0 0 0" />
    <parent link="robot_base_link" />
    <child link="servo_arm_1" />
    <axis xyz="-1 0 0" />
    <limit lower="-1.57" upper="0" effort="1.9" velocity="5.5" />
  </joint>

  <link name="table_arm_1">
    <inertial>
      <origin xyz="0.0020032 -0.030246 -1.1886E-08" rpy="0 0 0" />
      <mass value="0.0025632" />
      <inertia
        ixx="2.5398E-07" ixy="2.2472E-08" ixz="3.5056E-14"
        iyy="3.1017E-08" iyz="-3.7374E-13"
        izz="2.4742E-07" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table_arm.STL" />
      </geometry>
      <material name="">
        <color rgba="0.79216 0.81961 0.93333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table_arm.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="table_arm_1_revolute" type="revolute">
    <origin xyz="0.00455 0.039365 0" rpy="-0.47144 0 0" />
    <parent link="servo_arm_1" />
    <child link="table_arm_1" />
    <axis xyz="1 0 0" />
    <limit lower="-3.14" upper="0" effort="1.9" velocity="5.5" />
  </joint>

  <link name="table_arm_1_ball" />
  <joint name="table_arm_1_ball_joint" type="fixed" dont_collapse="true">
    <origin xyz="0.00275 -0.054583 0" rpy="0 0 0" />
    <parent link="table_arm_1" />
    <child link="table_arm_1_ball" />
  </joint>

  <!-- Servo arm 2 -->
  <link name="servo_arm_2">
    <inertial>
      <origin xyz="3.67444957071403E-05 0.0141374705075078 -2.06779038336435E-15" rpy="0 0 0" />
      <mass value="0.00309980999161893" />
      <inertia
        ixx="7.53064525555482E-07" ixy="2.15066959263787E-23" ixz="9.0989867380833E-24"
        iyy="5.9755946353975E-08" iyz="-1.34292772447984E-21"
        izz="7.06064992829684E-07" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/servo_arm.STL" />
      </geometry>
      <material name="">
        <color rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/servo_arm.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="servo_arm_2_revolute" type="revolute">
    <origin xyz="0.060579 0.026546 0.03755" rpy="-0.010265 0 2.0944" />
    <parent link="robot_base_link" />
    <child link="servo_arm_2" />
    <axis xyz="-1 0 0" />
    <limit lower="-1.57" upper="0" effort="1.9" velocity="5.5" />
  </joint>

  <link name="table_arm_2">
    <inertial>
      <origin xyz="0.00200322317368745 -0.0302455787102662 -7.30162207432383E-09" rpy="0 0 0" />
      <mass value="0.00256321315526102" />
      <inertia
        ixx="2.53975309310461E-07" ixy="2.24716883099034E-08" ixz="3.38452589465274E-14"
        iyy="3.1017255098745E-08" iyz="-2.38983580560879E-13"
        izz="2.47420430501569E-07" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table_arm.STL" />
      </geometry>
      <material name="">
        <color rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table_arm.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="table_arm_2_revolute" type="revolute">
    <origin xyz="0.00455 0.039365 0" rpy="-0.46126 0 0" />
    <parent link="servo_arm_2" />
    <child link="table_arm_2" />
    <axis xyz="1 0 0" />
    <limit lower="-3.14" upper="0" effort="1.9" velocity="5.5" />
  </joint>

  <link name="table_arm_2_ball" />
  <joint name="table_arm_2_ball_joint" type="fixed" dont_collapse="true">
    <origin xyz="0.00275 -0.054583 0" rpy="0 0 0" />
    <parent link="table_arm_2" />
    <child link="table_arm_2_ball" />
  </joint>

  <!-- Servo arm 3 (inertial fixed to match other arms) -->
  <link name="servo_arm_3">
    <inertial>
      <!-- Using same inertial values as servo_arm_2 (same model) -->
      <origin xyz="3.67444957071403E-05 0.0141374705075078 -2.06779038336435E-15" rpy="0 0 0" />
      <mass value="0.00309980999161893" />
      <inertia
        ixx="7.53064525555482E-07" ixy="2.15066959263787E-23" ixz="9.0989867380833E-24"
        iyy="5.9755946353975E-08" iyz="-1.34292772447984E-21"
        izz="7.06064992829684E-07" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/servo_arm.STL" />
      </geometry>
      <material name="">
        <color rgba="1 1 1 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/servo_arm.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="servo_arm_3_revolute" type="revolute">
    <origin xyz="-0.053279 0.03919 0.03755" rpy="-0.010265 0 -2.0944" />
    <parent link="robot_base_link" />
    <child link="servo_arm_3" />
    <axis xyz="-1 0 0" />
    <limit lower="-1.57" upper="0" effort="1.9" velocity="5.5" />
  </joint>

  <link name="table_arm_3">
    <inertial>
      <origin xyz="0.00200321165845766 -0.0302455610368241 -7.73754285990358E-09" rpy="0 0 0" />
      <mass value="0.00256319659543894" />
      <inertia
        ixx="2.53973421781188E-07" ixy="2.24712999182535E-08" ixz="1.10207121719404E-13"
        iyy="3.10171892862842E-08" iyz="-2.43362774805972E-13"
        izz="2.47418381574632E-07" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table_arm.STL" />
      </geometry>
      <material name="">
        <color rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table_arm.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="table_arm_3_revolute" type="revolute">
    <origin xyz="0.00455 0.039365 0" rpy="-0.46126 0 0" />
    <parent link="servo_arm_3" />
    <child link="table_arm_3" />
    <axis xyz="1 0 0" />
    <limit lower="-3.14" upper="0" effort="1.9" velocity="5.5" />
  </joint>

  <link name="table_arm_3_ball" />
  <joint name="table_arm_3_ball_joint" type="fixed" dont_collapse="true">
    <origin xyz="0.00275 -0.054583 0" rpy="0 0 0" />
    <parent link="table_arm_3" />
    <child link="table_arm_3_ball" />
  </joint>


  <!-- =======================
       TABLE (formerly ball_balancer_table)
       ======================= -->

  <link name="table_link">
    <inertial>
      <origin xyz="-3.06281976340791E-10 0.0024952689120884 6.22399215003891E-11" rpy="0 0 0" />
      <mass value="0.113623772682042" />
      <inertia
        ixx="0.000203272394718795" ixy="-4.39151056766037E-14" ixz="-1.44707292868474E-13"
        iyy="0.000406074363039218" iyz="8.22732076088615E-15"
        izz="0.000203272394445846" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table.STL" />
      </geometry>
      <material name="">
        <color rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ball_balancer2/meshes/table.STL" />
      </geometry>
    </collision>
  </link>

  <!-- Table is a free rigid body relative to robot base -->
  <joint name="robot_to_table_floating" type="fixed" dont_collapse="true">
    <origin xyz="0 0 0.0665733158" rpy="0 0 0"/>
    <parent link="robot_base_link"/>
    <child link="table_link"/>
  </joint>

  <!-- Magnet reference frames on the table -->
  <link name="table_magnet_1_link" />
  <joint name="table_magnet_1_joint" type="fixed" dont_collapse="true">
    <origin xyz="0 -0.075 -0.0045" rpy="0 0 3.1416" />
    <parent link="table_link" />
    <child link="table_magnet_1_link" />
  </joint>

  <link name="table_magnet_2_link" />
  <joint name="table_magnet_2_joint" type="fixed" dont_collapse="true">
    <origin xyz="0.064952 0.0375 -0.0045" rpy="0 0 3.1416" />
    <parent link="table_link" />
    <child link="table_magnet_2_link" />
  </joint>

  <link name="table_magnet_3_link" />
  <joint name="table_magnet_3_joint" type="fixed" dont_collapse="true">
    <origin xyz="-0.064952 0.0375 -0.0045" rpy="0 0 3.1416" />
    <parent link="table_link" />
    <child link="table_magnet_3_link" />
  </joint>


  <!-- =======================
       ISAAC SIM CLOSED-LOOP CONSTRAINTS
       ======================= -->
  <!-- These are Isaac Sim importer extensions (not standard URDF). -->
  <loop_joint name="leg1_ball_to_table" type="spherical">
    <link1 link="table_arm_1_ball" xyz="0 0 0" rpy="0 0 0"/>
    <link2 link="table_magnet_1_link" xyz="0 0 0" rpy="0 0 0"/>
  </loop_joint>

  <loop_joint name="leg2_ball_to_table" type="spherical">
    <link1 link="table_arm_2_ball" xyz="0 0 0" rpy="0 0 0"/>
    <link2 link="table_magnet_2_link" xyz="0 0 0" rpy="0 0 0"/>
  </loop_joint>

  <loop_joint name="leg3_ball_to_table" type="spherical">
    <link1 link="table_arm_3_ball" xyz="0 0 0" rpy="0 0 0"/>
    <link2 link="table_magnet_3_link" xyz="0 0 0" rpy="0 0 0"/>
  </loop_joint>

</robot>